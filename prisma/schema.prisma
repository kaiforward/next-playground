generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// ── Auth (NextAuth) ──────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  player   Player?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ── Game ─────────────────────────────────────────────────────────

model GameWorld {
  id               String   @id @default("world")
  currentTick      Int      @default(0)
  tickRate         Int      @default(5000)
  lastTickAt       DateTime @default(now())
  updatedAt        DateTime @updatedAt
  startingSystemId String?
}

model Region {
  id              String       @id @default(cuid())
  name            String       @unique
  governmentType  String       @default("federation")
  dominantEconomy String       @default("extraction") // Most common economy type in the region
  x               Float
  y               Float
  systems         StarSystem[]
  events          GameEvent[]
}

model Player {
  id        String   @id @default(cuid())
  userId    String   @unique
  credits   Float    @default(1000)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  ships         Ship[]
  tradeMissions TradeMission[]
}

model Ship {
  id                  String   @id @default(cuid())
  playerId            String
  name                String   @default("Starter Ship")
  shipType            String   @default("shuttle")
  fuel                Float    @default(100)
  maxFuel             Float    @default(100)
  cargoMax            Int      @default(50)
  status              String   @default("docked")
  systemId            String
  destinationSystemId String?
  departureTick       Int?
  arrivalTick         Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  system      StarSystem  @relation("ShipCurrentSystem", fields: [systemId], references: [id])
  destination StarSystem? @relation("ShipDestination", fields: [destinationSystemId], references: [id])
  cargo       CargoItem[]

  @@index([playerId])
}

model CargoItem {
  id       String @id @default(cuid())
  shipId   String
  goodId   String
  quantity Int

  ship Ship @relation(fields: [shipId], references: [id], onDelete: Cascade)
  good Good @relation(fields: [goodId], references: [id])

  @@unique([shipId, goodId])
}

model StarSystem {
  id          String  @id @default(cuid())
  name        String  @unique
  economyType String
  x           Float
  y           Float
  description String  @default("")
  regionId    String
  isGateway   Boolean @default(false)

  region            Region             @relation(fields: [regionId], references: [id])
  station           Station?
  traits            SystemTrait[]
  ships             Ship[]             @relation("ShipCurrentSystem")
  incomingShips     Ship[]             @relation("ShipDestination")
  connectionsFrom   SystemConnection[] @relation("FromSystem")
  connectionsTo     SystemConnection[] @relation("ToSystem")
  events            GameEvent[]
  priceHistory      PriceHistory?
  missionsPosted    TradeMission[]     @relation("MissionBoard")
  missionsTargeting TradeMission[]     @relation("MissionDest")

  @@index([regionId])
}

model SystemTrait {
  id       String @id @default(cuid())
  systemId String
  traitId  String // TraitId: asteroid_belt, habitable_world, etc.
  quality  Int    // QualityTier: 1 (Marginal), 2 (Solid), 3 (Exceptional)

  system StarSystem @relation(fields: [systemId], references: [id], onDelete: Cascade)

  @@unique([systemId, traitId])
  @@index([systemId])
}

model SystemConnection {
  id           String @id @default(cuid())
  fromSystemId String
  toSystemId   String
  fuelCost     Float  @default(10)

  fromSystem StarSystem @relation("FromSystem", fields: [fromSystemId], references: [id])
  toSystem   StarSystem @relation("ToSystem", fields: [toSystemId], references: [id])

  @@unique([fromSystemId, toSystemId])
}

model Station {
  id       String @id @default(cuid())
  name     String
  systemId String @unique

  system  StarSystem      @relation(fields: [systemId], references: [id])
  markets StationMarket[]
  trades  TradeHistory[]
}

model Good {
  id           String @id @default(cuid())
  name         String @unique
  description  String @default("")
  basePrice    Float
  tier         Int    @default(0)
  volume       Int    @default(1)
  mass         Float  @default(1.0)
  volatility   Float  @default(1.0)
  hazard       String @default("none")
  priceFloor   Float  @default(0.2)
  priceCeiling Float  @default(5.0)

  cargoItems    CargoItem[]
  markets       StationMarket[]
  trades        TradeHistory[]
  tradeMissions TradeMission[]
}

model StationMarket {
  id        String   @id @default(cuid())
  stationId String
  goodId    String
  supply    Float
  demand    Float
  updatedAt DateTime @updatedAt

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)
  good    Good    @relation(fields: [goodId], references: [id])

  @@unique([stationId, goodId])
}

model TradeHistory {
  id        String   @id @default(cuid())
  stationId String
  goodId    String
  price     Float
  quantity  Int
  type      String   // "buy" or "sell"
  playerId  String?
  createdAt DateTime @default(now())

  station Station @relation(fields: [stationId], references: [id])
  good    Good    @relation(fields: [goodId], references: [id])

  @@index([stationId])
}

model PriceHistory {
  id       String @id @default(cuid())
  systemId String @unique
  entries  String @default("[]") // JSON: { tick: number, prices: Record<goodId, price> }[]

  system StarSystem @relation(fields: [systemId], references: [id])
}

// ── Events ──────────────────────────────────────────────────────

model GameEvent {
  id             String  @id @default(cuid())
  type           String                        // Event definition key: "war", "plague", etc.
  phase          String                        // Current phase name: "tensions", "active", etc.
  systemId       String?                       // Target system (null for region-level events)
  regionId       String?                       // Target region
  startTick      Int                           // Tick when event was created
  phaseStartTick Int                           // Tick when current phase began
  phaseDuration  Int                           // Ticks until next phase transition
  severity       Float   @default(1.0)         // Intensity multiplier (spread events are weaker)
  sourceEventId  String?                       // Parent event (for spread events)
  metadata       String  @default("{}")        // JSON: event-specific data

  system        StarSystem?    @relation(fields: [systemId], references: [id])
  region        Region?        @relation(fields: [regionId], references: [id])
  sourceEvent   GameEvent?     @relation("EventSpread", fields: [sourceEventId], references: [id])
  spreadEvents  GameEvent[]    @relation("EventSpread")
  modifiers     EventModifier[]
  tradeMissions TradeMission[]

  @@index([type])
  @@index([systemId])
  @@index([regionId])
}

model EventModifier {
  id         String  @id @default(cuid())
  eventId    String
  domain     String                    // "economy", "navigation", "combat", "reputation"
  type       String                    // "equilibrium_shift", "rate_multiplier", "reversion_dampening"
  targetType String                    // "system", "region"
  targetId   String?                   // systemId or regionId
  goodId     String?                   // Specific good key, or null for all goods
  parameter  String                    // "supply_target", "demand_target", "production_rate", etc.
  value      Float                     // Modifier value

  event GameEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([domain, targetType, targetId])
  @@index([eventId])
}

// ── Trade Missions ──────────────────────────────────────────────

model TradeMission {
  id             String   @id @default(cuid())
  systemId       String                      // Board station (where mission appears)
  destinationId  String                      // Delivery target
  goodId         String
  quantity       Int
  reward         Int                         // Fixed CR payout
  deadlineTick   Int                         // Available missions expire here
  eventId        String?                     // Cascade-deletes with event
  factionId      String?                     // Future: faction reputation
  penaltyType    String   @default("none")   // Future: "credits" | "reputation"
  penaltyValue   Int      @default(0)
  playerId       String?                     // null = available, set = accepted
  acceptedAtTick Int?
  createdAtTick  Int

  system      StarSystem @relation("MissionBoard", fields: [systemId], references: [id])
  destination StarSystem @relation("MissionDest", fields: [destinationId], references: [id])
  good        Good       @relation(fields: [goodId], references: [id])
  event       GameEvent? @relation(fields: [eventId], references: [id], onDelete: Cascade)
  player      Player?    @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([systemId, playerId])
  @@index([playerId])
  @@index([deadlineTick])
  @@index([eventId])
}
