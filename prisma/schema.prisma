generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// ── Auth (NextAuth) ──────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  player   Player?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ── Game ─────────────────────────────────────────────────────────

model GameWorld {
  id          String   @id @default("world")
  currentTick Int      @default(0)
  tickRate    Int      @default(5000)
  lastTickAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Player {
  id        String   @id @default(cuid())
  userId    String   @unique
  credits   Float    @default(1000)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  ships Ship[]
}

model Ship {
  id                  String   @id @default(cuid())
  playerId            String
  name                String   @default("Starter Ship")
  fuel                Float    @default(100)
  maxFuel             Float    @default(100)
  cargoMax            Int      @default(50)
  status              String   @default("docked")
  systemId            String
  destinationSystemId String?
  departureTick       Int?
  arrivalTick         Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  system      StarSystem  @relation("ShipCurrentSystem", fields: [systemId], references: [id])
  destination StarSystem? @relation("ShipDestination", fields: [destinationSystemId], references: [id])
  cargo       CargoItem[]

  @@index([playerId])
}

model CargoItem {
  id       String @id @default(cuid())
  shipId   String
  goodId   String
  quantity Int

  ship Ship @relation(fields: [shipId], references: [id], onDelete: Cascade)
  good Good @relation(fields: [goodId], references: [id])

  @@unique([shipId, goodId])
}

model StarSystem {
  id          String @id @default(cuid())
  name        String @unique
  economyType String
  x           Float
  y           Float
  description String @default("")

  station         Station?
  ships           Ship[]             @relation("ShipCurrentSystem")
  incomingShips   Ship[]             @relation("ShipDestination")
  connectionsFrom SystemConnection[] @relation("FromSystem")
  connectionsTo   SystemConnection[] @relation("ToSystem")
}

model SystemConnection {
  id           String @id @default(cuid())
  fromSystemId String
  toSystemId   String
  fuelCost     Float  @default(10)

  fromSystem StarSystem @relation("FromSystem", fields: [fromSystemId], references: [id])
  toSystem   StarSystem @relation("ToSystem", fields: [toSystemId], references: [id])

  @@unique([fromSystemId, toSystemId])
}

model Station {
  id       String @id @default(cuid())
  name     String
  systemId String @unique

  system  StarSystem      @relation(fields: [systemId], references: [id])
  markets StationMarket[]
  trades  TradeHistory[]
}

model Good {
  id        String @id @default(cuid())
  name      String @unique
  basePrice Float
  category  String

  cargoItems CargoItem[]
  markets    StationMarket[]
  trades     TradeHistory[]
}

model StationMarket {
  id        String   @id @default(cuid())
  stationId String
  goodId    String
  supply    Float
  demand    Float
  updatedAt DateTime @updatedAt

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)
  good    Good    @relation(fields: [goodId], references: [id])

  @@unique([stationId, goodId])
}

model TradeHistory {
  id        String   @id @default(cuid())
  stationId String
  goodId    String
  price     Float
  quantity  Int
  type      String   // "buy" or "sell"
  playerId  String?
  createdAt DateTime @default(now())

  station Station @relation(fields: [stationId], references: [id])
  good    Good    @relation(fields: [goodId], references: [id])

  @@index([stationId])
}
