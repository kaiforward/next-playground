# Combat & Operational Missions

Tick-based combat engine and non-trade mission system. Covers pirate bounty encounters, timed patrol/survey missions, and the battle resolution mechanics that faction wars will later extend.

---

## Operational Mission Types

Three mission types generated by the `missions` tick processor, independent of factions:

| Type | Stat Gate | Duration | Trigger | Reward Range |
|---|---|---|---|---|
| **Patrol** | Firepower ≥ 5 | 15–25 ticks | System danger > 0.15 | 200–500 CR (scales with danger) |
| **Survey** | Sensors ≥ 6 | 10–15 ticks | System has eligible trait | 150–400 CR (scales with trait quality) |
| **Bounty** | Firepower ≥ 4, Hull ≥ 30 | Battle-driven | System danger > 0.20 | 300–800 CR (scales with enemy tier) |

### Mission Lifecycle

1. **Generated** — tick processor creates candidates from system danger levels and traits
2. **Available** — displayed on system's Operations board (Contracts tab → Operations sub-tab)
3. **Accepted** — player assigns an eligible ship (passes stat gates, docked at system, not disabled)
4. **In Progress** — ship arrives at target system:
   - Patrol/Survey: ship committed for duration (cannot navigate/trade)
   - Bounty: battle created, ship locked until resolution
5. **Completed** — timed missions finish on schedule; bounties resolve through combat
6. **Failed** — deadline passed, ship destroyed/disabled, or player abandons

### Generation Sources

- **Danger-based** (patrol, bounty): Computed from event modifiers + government danger baseline + trait danger (`computeTraitDanger`). Higher danger = more missions and tougher enemies.
- **Trait-based** (survey): Systems with survey-eligible traits: `precursor_ruins`, `gravitational_anomaly`, `binary_star`, `dark_nebula`, `exotic_matter_deposits`, `tidal_locked`. Trait quality affects reward.

### Constraints

- Max 4 available operational missions per system (`OP_MISSION_CAP_PER_SYSTEM`)
- Unclaimed missions expire after 200 ticks (`OP_MISSION_DEADLINE_TICKS`)
- One ship per mission (no convoy missions yet)
- Ship must be docked, not disabled, not already committed to another mission

---

## Combat Engine

Pure functions in `lib/engine/combat.ts`. No DB dependency — all state is passed in and results returned. Designed to extend to fleet battles and faction wars.

### Combat Stats

**Player side** — derived from ship stats:

| Stat | Formula |
|---|---|
| Strength | `hullCurrent + shieldCurrent` |
| Damage per round | `firepower × 1.5` (FIREPOWER_TO_DAMAGE) |
| Damage reduction | `evasion / (evasion + 20)`, capped at 40% (diminishing returns) |
| Starting morale | `85 + (hullCurrent / hullMax × 15)` (healthy ships fight better) |

**Enemy side** — derived from tier + system danger:

| Tier | Danger Threshold | Base Strength | Base Damage | Base Morale |
|---|---|---|---|---|
| Weak | < 0.25 | 30 | 4 | 60 |
| Moderate | 0.25–0.39 | 55 | 7 | 75 |
| Strong | ≥ 0.40 | 85 | 11 | 85 |

All enemy stats scale by `1 + (dangerLevel × 0.5)` for additional variance.

### Round Resolution

Rounds resolve every 6 ticks (`ROUND_INTERVAL`). Each round:

1. **Damage calculation** — both sides deal damage simultaneously
   - Raw damage = `damagePerRound × (1 + variance)` where variance is ±20%
   - Net damage = raw × `(1 - target.damageReduction)`
2. **Strength update** — subtract net damage from strength (min 0)
3. **Morale shift** — the side that took more damage loses morale proportional to the casualty ratio
   - Base loss: 3 morale for the losing side, base gain: 2 for the winning side
   - Lopsided rounds (>2:1 damage ratio): additional 8 morale swing
4. **Battle end check** — after each round:
   - Strength ≤ 0 → destroyed (victory or defeat)
   - Morale ≤ 15 → retreat (player_retreat or enemy_retreat)

### Battle Outcomes

| Outcome | Ship Damage | Reward | Mission Status |
|---|---|---|---|
| Player Victory | Proportional to strength lost (hull/shield) | Full reward | Completed |
| Enemy Retreat | Same as victory | 60% reward | Completed |
| Player Defeat | Heavy damage, possible disable | None | Failed |
| Player Retreat | Moderate damage | None | Failed |

**Damage translation**: Battle strength loss maps back to ship hull/shield damage proportionally. If a ship entered with 80 strength (50 hull + 30 shield) and exits with 40, it lost 50% — shield absorbs first, then hull.

---

## Database Models

### Mission

Key fields: `type` (patrol/survey/bounty), `systemId` (where posted), `targetSystemId` (where executed), `reward`, `deadlineTick`, `durationTicks` (null for bounty), `enemyTier` (bounty only), `statRequirements` (JSON), `status` (available → accepted → in_progress → completed/failed), `playerId`, `shipId`, `startedAtTick`.

Indexes on `[systemId, status]`, `[playerId]`, `[deadlineTick]`, `[targetSystemId, status]`.

### Battle

Key fields: `type` ("pirate_encounter"), `systemId`, `missionId` (unique), `shipId`, `status` (active → resolution), `playerStrength/Morale`, `enemyStrength/Morale`, `enemyType/Tier`, `roundsCompleted`, `roundInterval` (6), `nextRoundTick`, `roundHistory` (JSON array of round results).

Indexes on `[status, nextRoundTick]`, `[systemId]`, `[shipId]`.

---

## Tick Processors

### `missions` Processor

- **Frequency**: 5 (same as trade-missions)
- **Dependencies**: events, economy
- **Actions each run**:
  1. Expire unclaimed missions past deadline
  2. Complete timed missions (patrol/survey) where `startedAtTick + durationTicks ≤ currentTick` — credit player, free ship
  3. Fail missions where committed ship was destroyed/disabled
  4. Generate new candidates from danger levels + traits (capped per system)

### `battles` Processor

- **Frequency**: 1 (every tick, but only resolves rounds when `nextRoundTick ≤ currentTick`)
- **Dependencies**: ship-arrivals
- **Actions each run**:
  1. Find active battles due for resolution
  2. Resolve round via combat engine
  3. Update strength/morale, append to round history
  4. On battle end: apply ship damage, credit rewards (or fail mission), free ship
  5. Emit SSE events for battle updates

### Ship Arrivals Integration

When a ship arrives at a system with an accepted mission targeting that system:
- **Bounty**: Creates a `Battle` record, sets mission to `in_progress`, ship cannot navigate/trade
- **Patrol/Survey**: Sets mission to `in_progress` with `startedAtTick`, ship committed for duration

---

## UI Components

### Battle Viewer (`components/fleet/battle-viewer.tsx`)

Full battle display shown on the ship detail page when the ship is in combat:
- Strength bars (player green, enemy red) with percentage
- Morale labels: Confident (≥80), Steady (≥50), Shaken (≥25), Breaking (<25)
- Round history table (damage dealt/taken per round)
- Status badge (In Progress, Victory, Defeated, Retreated, Enemy Retreated)

### Operations Panel (`components/missions/operations-panel.tsx`)

Available and active operational missions, shown on the Contracts tab (Operations sub-tab):
- Available: type/tier badges, target system, stat requirements, reward, deadline, ship selector
- Active: type badge, target, progress text, reward, abandon button

### Ship Card / Dashboard Integration

- Ship cards show "In Battle" purple badge when committed to active battle
- Dashboard Active Missions card shows operational missions alongside trade missions
- Ship detail page renders battle viewer above ship stats when in combat

---

## API Routes

| Route | Method | Description |
|---|---|---|
| `/api/game/op-missions?systemId=X` | GET | Available + active operational missions (optionally filtered by system) |
| `/api/game/op-missions/[missionId]/accept` | POST | Accept mission with `{ shipId }` |
| `/api/game/op-missions/[missionId]/abandon` | POST | Abandon accepted/in-progress mission (not during active battle) |
| `/api/game/battles` | GET | Player's active battles |
| `/api/game/battles/[battleId]` | GET | Single battle detail |

---

## Extensibility

The combat engine is designed for reuse by the faction war system (Layer 2):

- **Fleet battles**: `derivePlayerCombatStats` can aggregate across multiple ships. The round resolution math (simultaneous damage, morale cascades) scales to fleet-level engagements.
- **Enemy variety**: The enemy tier system can be extended beyond pirates — faction navies, mercenary bands, etc. Just add new tier definitions.
- **Stratagems**: Round resolution can accept modifier functions for special abilities, tactical choices, or terrain effects.
- **Reinforcements**: The battle model supports adding/removing combatants between rounds.
- **Siege mechanics**: Strength/morale framework maps naturally to fortification assault with defender advantages.

---

## Related Docs

- **[Navigation (active)](./navigation.md)** — ship stats, danger pipeline, convoy system
- **[Trading (active)](./trading.md)** — trade missions (the other mission type)
- **[Tick Engine (active)](./tick-engine.md)** — processor pipeline
- **[Missions (planned)](../planned/missions.md)** — full mission vision including faction-gated types
- **[War System (planned)](../planned/war-system.md)** — faction wars that extend this combat engine
